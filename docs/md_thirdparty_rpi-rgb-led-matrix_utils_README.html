<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TouchLED-Library: Utilities</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TouchLED-Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Utilities </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Unfold: Standard LED-matrix options present in all utilities</p>
<p>This contains useful utilities that might be directly useful without having to write any code.</p>
<p>Below, the description of the utilities contains a list of commandline flags they support. Next to the specific flags for their use, they all have a set of standard options that always come with the LED matrix, such as choosing the <code>--led-rows</code> or <code>--led-chain</code>.</p>
<p>For brevity, we don't repeat them below in the synopsis prints of each of these utilities. You find a description of the standard options in the <a href="../README.md#changing-parameters-via-command-line-flags">toplevel readme</a></p>
<p>&lt;details&gt;</p>
<div class="fragment"><div class="line">--led-gpio-mapping=&lt;name&gt; : Name of GPIO mapping used. Default &quot;regular&quot;</div><div class="line">--led-rows=&lt;rows&gt;         : Panel rows. Typically 8, 16, 32 or 64. (Default: 32).</div><div class="line">--led-cols=&lt;cols&gt;         : Panel columns. Typically 32 or 64. (Default: 32).</div><div class="line">--led-chain=&lt;chained&gt;     : Number of daisy-chained panels. (Default: 1).</div><div class="line">--led-parallel=&lt;parallel&gt; : Parallel chains. range=1..3 (Default: 1).</div><div class="line">--led-multiplexing=&lt;0..11&gt; : Mux type: 0=direct; 1=Stripe; 2=Checkered; 3=Spiral; 4=ZStripe; 5=ZnMirrorZStripe; 6=coreman; 7=Kaler2Scan; 8=ZStripeUneven; 9=P10-128x4-Z; 10=QiangLiQ8; 11=InversedZStripe (Default: 0)</div><div class="line">--led-pixel-mapper        : Semicolon-separated list of pixel-mappers to arrange pixels.</div><div class="line">                                   Optional params after a colon e.g. &quot;U-mapper;Rotate:90&quot;</div><div class="line">                                   Available: &quot;Mirror&quot;, &quot;Rotate&quot;, &quot;U-mapper&quot;. Default: &quot;&quot;</div><div class="line">--led-pwm-bits=&lt;1..11&gt;    : PWM bits (Default: 11).</div><div class="line">--led-brightness=&lt;percent&gt;: Brightness in percent (Default: 100).</div><div class="line">--led-scan-mode=&lt;0..1&gt;    : 0 = progressive; 1 = interlaced (Default: 0).</div><div class="line">--led-row-addr-type=&lt;0..4&gt;: 0 = default; 1 = AB-addressed panels; 2 = direct row select; 3 = ABC-addressed panels; 4 = ABC Shift + DE direct (Default: 0).</div><div class="line">--led-show-refresh        : Show refresh rate.</div><div class="line">--led-inverse             : Switch if your matrix has inverse colors on.</div><div class="line">--led-rgb-sequence        : Switch if your matrix has led colors swapped (Default: &quot;RGB&quot;)</div><div class="line">--led-pwm-lsb-nanoseconds : PWM Nanoseconds for LSB (Default: 130)</div><div class="line">--led-pwm-dither-bits=&lt;0..2&gt; : Time dithering of lower bits (Default: 0)</div><div class="line">--led-no-hardware-pulse   : Don&#39;t use hardware pin-pulse generation.</div><div class="line">--led-panel-type=&lt;name&gt;   : Needed to initialize special panels. Supported: &#39;FM6126A&#39;</div><div class="line">--led-slowdown-gpio=&lt;0..4&gt;: Slowdown GPIO. Needed for faster Pis/slower panels (Default: 1).</div><div class="line">--led-daemon              : Make the process run in the background as daemon.</div><div class="line">--led-no-drop-privs       : Don&#39;t drop privileges from &#39;root&#39; after initializing the hardware.</div></div><!-- fragment --><p> &lt;/details&gt;</p>
<h3>Image Viewer</h3>
<p>The image viewer reads all kinds of image formats, including animated gifs.</p>
<p>To speed up lengthy loading of image files or animations, you also can also pre-process images or animations and write them to a 'stream' file that then later can be loaded very quickly by this viewer (at the expense of disk-space as these are not compressed). This is in particular useful for large panels and animations with many frames: less loading time and less RAM used. See <code>-O</code> example below in the example section.</p>
<h5>Building</h5>
<p>The <code>led-image-viewer</code> requires the GraphicsMagick dependency first, then it can be built with <code>make led-image-viewer</code>.</p>
<div class="fragment"><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install libgraphicsmagick++-dev libwebp-dev -y</div><div class="line">make led-image-viewer</div></div><!-- fragment --><h5>Usage</h5>
<p>The resulting binary has a couple of flags. </p><div class="fragment"><div class="line">usage: ./led-image-viewer [options] &lt;image&gt; [option] [&lt;image&gt; ...]</div><div class="line">Options:</div><div class="line">        -O&lt;streamfile&gt;            : Output to stream-file instead of matrix (Don&#39;t need to be root).</div><div class="line">        -C                        : Center images.</div><div class="line"></div><div class="line">These options affect images FOLLOWING them on the command line,</div><div class="line">so it is possible to have different options for each image</div><div class="line">        -w&lt;seconds&gt;               : Regular image: Wait time in seconds before next image is shown (default: 1.5).</div><div class="line">        -t&lt;seconds&gt;               : For animations: stop after this time.</div><div class="line">        -l&lt;loop-count&gt;            : For animations: number of loops through a full cycle.</div><div class="line">        -D&lt;animation-delay-ms&gt;    : For animations: override the delay between frames given in the</div><div class="line">                                    gif/stream animation with this value. Use -1 to use default value.</div><div class="line">        -V&lt;vsync-multiple&gt;        : For animation (expert): Only do frame vsync-swaps on multiples of refresh (default: 1)</div><div class="line">                                    (Tip: use --led-limit-refresh for stable rate)</div><div class="line"></div><div class="line">Options affecting display of multiple images:</div><div class="line">        -f                        : Forever cycle through the list of files on the command line.</div><div class="line">        -s                        : If multiple images are given: shuffle.</div><div class="line"></div><div class="line">General LED matrix options:</div><div class="line">        &lt;... all the --led- options&gt;</div><div class="line"></div><div class="line">Switch time between files: -w for static images; -t/-l for animations</div><div class="line">Animated gifs: If both -l and -t are given, whatever finishes first determines duration.</div><div class="line"></div><div class="line">The -w, -t and -l options apply to the following images until a new instance of one of these options is seen.</div><div class="line">So you can choose different durations for different images.</div></div><!-- fragment --><p>Then, you can run it with any common image format, including animated gifs:</p>
<h5>Examples</h5>
<div class="fragment"><div class="line">sudo ./led-image-viewer some-image.jpg       # Display an image.</div><div class="line">sudo ./led-image-viewer animated.gif         # Show an animated gif</div><div class="line">sudo ./led-image-viewer -t5 animated.gif     # Show an animated gif for 5 seconds</div><div class="line">sudo ./led-image-viewer -l2 animated.gif     # Show an animated gif for 2 loops</div><div class="line">sudo ./led-image-viewer -D16 animated.gif    # Play animated gif, use 16ms frame delay</div><div class="line"></div><div class="line"># If you want to have an even frame rate, that is depending on your</div><div class="line"># refresh rate, use the following. Note, your refresh rate is dependent on</div><div class="line"># factors such as chain length and rows; use --led-show-refresh to get an idea.</div><div class="line"># Then fix it with --led-limit-refresh</div><div class="line">sudo ./led-image-viewer --led-limit-refresh=200 -D0 -V10 animated.gif # Frame rate = 1/12 refresh rate</div><div class="line"></div><div class="line">sudo ./led-image-viewer    -w3 foo.jpg bar.png  # show two images, wait 3 seconds between. Stop.</div><div class="line">sudo ./led-image-viewer    -w3 foo.jpg -w2 bar.png baz.png  # show images, wait 3 seconds after the first, 2 seconds after the second and third. Stop.</div><div class="line">sudo ./led-image-viewer -f -w3 foo.jpg bar.png  # show images, wait 3sec between, go back and loop forever</div><div class="line"></div><div class="line">sudo ./led-image-viewer -f -w3 *.png *.jpg   # Loop forever through a list of images</div><div class="line"></div><div class="line">sudo ./led-image-viewer -f -s *.png  # Loop forever but randomize (shuffle) each round.</div><div class="line"></div><div class="line"># Show image.png and animated.gif in a loop. Show the static image for 3 seconds</div><div class="line"># while the animation is shown for 5 seconds (-t takes precedence for animated</div><div class="line"># images over -w)</div><div class="line">sudo ./led-image-viewer -f -w3 -t5 image.png animated.gif</div><div class="line"></div><div class="line"># Create a fast animation from a bunch of *.png files</div><div class="line"># with 16.6ms frame time (=60Hz) and write to a raw animation stream</div><div class="line"># animation-out.stream (beware, uncompressed, uses lots of disk).</div><div class="line"># Note:</div><div class="line">#  o We have to supply all the options (rows, chain, parallel, hardware-mapping,</div><div class="line">#    rotation etc), that we would supply to the real viewer later.</div><div class="line">#  o We don&#39;t need to be root, as we don&#39;t write to the matrix</div><div class="line">./led-image-viewer --led-rows=32 --led-chain=4 --led-parallel=3 -w0.016667 *.png -Oanimation-out.stream</div><div class="line"></div><div class="line"># Now, play back this animation.</div><div class="line">sudo ./led-image-viewer --led-rows=32 --led-chain=4 --led-parallel=3 animation-out.stream</div></div><!-- fragment --><h3>Text Scroller</h3>
<p>The text scroller allows to show some scrolling text.</p>
<p>##### Building </p><div class="fragment"><div class="line">make text-scroller</div></div><!-- fragment --><h5>Usage</h5>
<div class="fragment"><div class="line">usage: ./text-scroller [options] &lt;text&gt;</div><div class="line">Takes text and scrolls it with speed -s</div><div class="line">Options:</div><div class="line">        -f &lt;font-file&gt;    : Path to *.bdf-font to be used.</div><div class="line">        -s &lt;speed&gt;        : Approximate letters per second.</div><div class="line">                            Positive: scroll right to left; Negative: scroll left to right</div><div class="line">                            (Zero for no scrolling)</div><div class="line">        -l &lt;loop-count&gt;   : Number of loops through the text. -1 for endless (default)</div><div class="line">        -b &lt;on-time&gt;,&lt;off-time&gt;  : Blink while scrolling. Keep on and off for these amount of scrolled pixels.</div><div class="line">        -x &lt;x-origin&gt;     : Shift X-Origin of displaying text (Default: 0)</div><div class="line">        -y &lt;y-origin&gt;     : Shift Y-Origin of displaying text (Default: 0)</div><div class="line">        -t &lt;track-spacing&gt;: Spacing pixels between letters (Default: 0)</div><div class="line"></div><div class="line">        -C &lt;r,g,b&gt;        : Text Color. Default 255,255,255 (white)</div><div class="line">        -B &lt;r,g,b&gt;        : Background-Color. Default 0,0,0</div><div class="line">        -O &lt;r,g,b&gt;        : Outline-Color, e.g. to increase contrast.</div><div class="line"></div><div class="line">General LED matrix options:</div><div class="line">        &lt;... all the --led- options&gt;</div></div><!-- fragment --><p>You need to specify a font for the tool to use. We are using BDF-fonts, which are bitmap fonts nicely suited for low-resolution displays such as ours. A few fonts you find in the <a href="../fonts">../fonts</a> directory. The ../fonts/README.md "README.md" there also describes how to make your own.</p>
<h5>Examples</h5>
<div class="fragment"><div class="line"># (use your --led-rows, --led-chain and --led-parallel suited for your setup)</div><div class="line"></div><div class="line"># Red (-C) text on a display with 4 chained displays. Notice you can use UTF-8 characters</div><div class="line"># if they are supported by the font.</div><div class="line">sudo ./text-scroller -f ../fonts/9x18.bdf -C255,0,0 --led-chain=4 &quot;Hello World ♥&quot;</div><div class="line"></div><div class="line"># .. faster speed; roughly 20 characters per second with option -s.</div><div class="line">sudo ./text-scroller -f ../fonts/9x18.bdf -C255,0,0 --led-chain=4 -s20 &quot;The quick brown fox jumps over the lazy dog&quot;</div><div class="line"></div><div class="line"># A speed of zero does just shows the text, no scrolling.</div><div class="line">sudo ./text-scroller -f ../fonts/9x18.bdf -C255,0,0 --led-chain=4 -s0 &quot;No Scroll&quot;</div><div class="line"></div><div class="line"># A text might need to be arranged a bit. Let&#39;s move it 15 pixels to the right and 5 down:</div><div class="line">sudo ./text-scroller -f ../fonts/9x18.bdf -C255,0,0 --led-chain=4 -s0 -x15 -y5 &quot;Shifted&quot;</div><div class="line"></div><div class="line"># Now text in red color on a blue background (-B). We choose an outline (-O)</div><div class="line"># of a slightly darker blue for better contrast</div><div class="line">sudo ./text-scroller -f ../fonts/9x18.bdf -B0,0,255 -O0,0,100 -C255,0,0 --led-chain=4 &quot;Contrast outline&quot;</div><div class="line"></div><div class="line"># A larger font. This one needs a bit of an y-adjustment</div><div class="line"># (move up 11 pixels: a negative y shift) to fit nicely on a panel.</div><div class="line">sudo ./text-scroller -f ../fonts/texgyre-27.bdf --led-chain=4 -y-11 &quot;Large Font&quot;</div></div><!-- fragment --><h3>Video Viewer</h3>
<p>The video viewer allows to play common video formats on the RGB matrix (just the picture, no sound).</p>
<p>This is currently doing a software decode; if you are familiar with the av libraries, a pull request that adds hardware decoding is welcome.</p>
<p>Right now, this is CPU intensive and decoding can result in an output that is not smooth or presents flicker, in particular on older Pis. If you observe that, it is suggested to prepare a preprocessed stream that you then later watch with <code>led-image-viewer</code> (see example below). This will use a bit of disk-space, but it will result in best quality as all the expensive calculation has been done beforehand.</p>
<p>Short of that, if you want to use the video viewer directly (e.g. because the stream file would be super-large), do the following when you observe flicker:</p><ul>
<li>Use the <code>-T</code> option to add more decode threads; <code>-T2</code> or <code>-T3</code> typically.</li>
<li>Transcode the video first to the width and height of the final output size so that decoding and scaling is much cheaper at runtime.</li>
<li>If you use tools such as <a href="https://youtube-dl.org/">youtube-dl</a> to acquire the video, tell it to choose a low resolution version (e.g. for that program use option <code>-f"[height&lt;480]"</code>).</li>
<li>Synchronize output as integer fraction of matrix refresh rate (example below).</li>
<li>Another route to watch videos is to run a <a href="https://github.com/hzeller/flaschen-taschen/tree/master/server#rgb-matrix-panel-display">flaschen-taschen</a> server on your Pi, that provides a network interface to your LED-Matrix. Now, you can use <a href="https://www.videolan.org/vlc">vlc</a> from some other computer on your network and stream the output to your Pi. You have to provide the IP address and size of the panel: ``` vlc &ndash;vout flaschen &ndash;flaschen-display=&lt;IP-address-of-your-pi&gt; \ &ndash;flaschen-width=128 &ndash;flaschen-height=64 \ &lt;video-filename-or-YouTube-URL&gt; ```</li>
</ul>
<h5>Building</h5>
<p>The video-viewer requires some dependencies first, then it can be built with <code>make video-viewer</code>.</p>
<div class="fragment"><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install pkg-config libavcodec-dev libavformat-dev libswscale-dev</div><div class="line">make video-viewer</div></div><!-- fragment --><h5>Usage</h5>
<div class="fragment"><div class="line">Show one or a sequence of video files on the RGB-Matrix</div><div class="line">usage: ./video-viewer [options] &lt;video&gt; [&lt;video&gt;...]</div><div class="line">Options:</div><div class="line">        -F                 : Full screen without black bars; aspect ratio might suffer</div><div class="line">        -O&lt;streamfile&gt;     : Output to stream-file instead of matrix (don&#39;t need to be root).</div><div class="line">        -s &lt;count&gt;         : Skip these number of frames in the beginning.</div><div class="line">        -c &lt;count&gt;         : Only show this number of frames (excluding skipped frames).</div><div class="line">        -V&lt;vsync-multiple&gt; : Instead of native video framerate, playback framerate</div><div class="line">                             is a fraction of matrix refresh. In particular with a stable refresh,</div><div class="line">                             this can result in more smooth playback. Choose multiple for desired framerate.</div><div class="line">                             (Tip: use --led-limit-refresh for stable rate)</div><div class="line">        -T &lt;threads&gt;       : Number of threads used to decode (default 1, max=4)</div><div class="line">        -v                 : verbose; prints video metadata and other info.</div><div class="line">        -f                 : Loop forever.</div><div class="line"></div><div class="line">General LED matrix options:</div><div class="line">        &lt;... all the --led- options&gt;</div></div><!-- fragment --><h5>Examples</h5>
<div class="fragment"><div class="line"># Play video. If you observe that the Pi has trouble to keep up (extensive</div><div class="line"># flickering), transcode the video first to the exact size of your display.</div><div class="line">sudo ./video-viewer --led-chain=4 --led-parallel=3 -T2 myvideo.webm</div><div class="line"></div><div class="line"># If you observe flicker you can try to synchronize video output with</div><div class="line"># the refresh rate of the panel. For that, first figure out with</div><div class="line"># --led-show-refresh what the &#39;natural&#39; refresh rate is of your LED panel.</div><div class="line"># Then choose one that is lower and a multiple of the frame-rate of the</div><div class="line"># video. Let&#39;s say we have a video with a framerate of 25fps and find that</div><div class="line"># our panel can refresh with more than 200Hz (after the usual refresh</div><div class="line"># tweakings such as with --led-pwm-dither-bits).</div><div class="line"># Let&#39;s fix the refresh rate to 200 and sync a new frame with every</div><div class="line"># 8th refresh to get the desired video fps (200/8 = 25)</div><div class="line">sudo ./video-viewer --led-chain=4 --led-parallel=3 --led-limit-refresh=200 -V8 myvideo.webm</div></div><!-- fragment --><p><b>Example preparing a preprocessed stream</b></p>
<div class="fragment"><div class="line"># A way to avoid flicker playback with best possible results even with</div><div class="line"># very high framerate: create a preprocessed stream first, then replay it with</div><div class="line"># led-image-viewer. This results in best quality (no CPU use at play-time), but</div><div class="line"># comes with a caveat: It can use _A LOT_ of disk, as it is not compressed.</div><div class="line"># Note:</div><div class="line">#  o We don&#39;t need to be root, as we don&#39;t write to the matrix, just to a file.</div><div class="line">#  o We have to supply all the options (rows, chain, parallel, hardware-mapping,</div><div class="line">#    rotation etc), that we would supply to the real viewer later as the</div><div class="line">#    framebuffer is fully pre-processed to avoid any overhead while playing.</div><div class="line">#  o You could even run this on your much faster regular Linux PC (little</div><div class="line">#    endian) and create a stream that you then can play on your Pi.</div><div class="line"># ----- STEP 1 Preprocessing ------</div><div class="line">./video-viewer --led-chain=5 --led-parallel=3 -T4 myvideo.mp4 -O/tmp/vid.stream</div><div class="line"></div><div class="line">#.. now play the resulting stream with the with led-image-viewer. Also try</div><div class="line"># using -D or -V to replay with different frame rate.</div><div class="line"># Note, you need to give the same options (rows, chain, parallel etc.) as</div><div class="line"># you did when creating the stream.</div><div class="line"># ----- STEP 2 Actual Playing ------</div><div class="line">sudo ./led-image-viewer --led-chain=5 --led-parallel=3 /tmp/vid.stream</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
